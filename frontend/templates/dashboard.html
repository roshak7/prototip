{% extends "base.html" %}

{% block title %}Дашборд{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Дашборд</h1>
    
    <!-- KPI-виджеты -->
    <div class="kpi-cards">
        <div class="kpi-card">
            <h4>Объем выпуска</h4>
            <p class="value">{{ total_output|floatformat:0 }} ед.</p>
        </div>
        <div class="kpi-card">
            <h4>Простои</h4>
            <p class="value">{{ avg_downtime }} ч</p>
        </div>
        <div class="kpi-card">
            <h4>Брак</h4>
            <p class="value">{{ avg_defect_rate }}%</p>
        </div>
        <div class="kpi-card">
            <h4>Загрузка оборудования</h4>
            <p class="value">{{ avg_equipment_load }}%</p>
        </div>
        <div class="kpi-card">
            <h4>Остатки на складе</h4>
            <p class="value">{{ total_inventory|floatformat:0 }} ед.</p>
        </div>
        <div class="kpi-card">
            <h4>Изготовлено шкафов</h4>
            <p class="value">{{ total_cabinets|floatformat:0 }} шт.</p>
        </div>
        <div class="kpi-card">
            <h4>Выполнение плана</h4>
            <p class="value">{{ avg_plan_completion }}%</p>
        </div>
        <div class="kpi-card">
            <h4>Индекс качества</h4>
            <p class="value">{{ avg_quality_index }}%</p>
        </div>
    </div>
    
    <!-- Фильтры -->
    <div class="filters">
        <h3>Фильтры</h3>
        <form id="filterForm" method="get">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="period">Период</label>
                    <select class="form-select" id="period" name="period">
                        <option value="day" {% if selected_period == 'day' %}selected{% endif %}>День</option>
                        <option value="week" {% if selected_period == 'week' %}selected{% endif %}>Неделя</option>
                        <option value="month" {% if selected_period == 'month' %}selected{% endif %}>Месяц</option>
                        <option value="quarter" {% if selected_period == 'quarter' %}selected{% endif %}>Квартал</option>
                        <option value="year" {% if selected_period == 'year' %}selected{% endif %}>Год</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="shop">Цех</label>
                    <select class="form-select" id="shop" name="shop" multiple>
                        {% for shop in shops %}
                            <option value="{{ shop.id }}" {% if shop.id in selected_shops %}selected{% endif %}>{{ shop.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="shop-selection-indicator" id="shop-selection-indicator">
                        {% if selected_shops %}
                            Выбрано: {{ selected_shops|length }} цех{{ selected_shops|length|pluralize:"а,ов" }}
                        {% else %}
                            Выбрано: все цеха
                        {% endif %}
                    </div>
                </div>
                <div class="filter-group">
                    <label>Тип показателя</label>
                    <div class="filter-checkboxes">
                        <div class="filter-checkbox">
                            <input type="checkbox" id="output" name="indicator" value="output" {% if 'output' in selected_indicators %}checked{% endif %}>
                            <label for="output">Выпуск</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="downtime" name="indicator" value="downtime" {% if 'downtime' in selected_indicators %}checked{% endif %}>
                            <label for="downtime">Простои</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="defect" name="indicator" value="defect" {% if 'defect' in selected_indicators %}checked{% endif %}>
                            <label for="defect">Брак</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="load" name="indicator" value="load" {% if 'load' in selected_indicators %}checked{% endif %}>
                            <label for="load">Загрузка</label>
                        </div>
                    </div>
                </div>
                <div class="filter-group d-flex align-items-end">
                    <button type="submit" class="apply-button me-2">
                        Применить
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="resetFilters">
                        Сбросить
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Графики -->
    <div class="charts">
        <div class="chart-container">
            <h3>Простои по цехам</h3>
            <div class="chart-wrapper">
                <canvas id="downtimeChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>Выпуск продукции за период</h3>
            <div class="chart-wrapper">
                <canvas id="productionChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>Остатки на складе</h3>
            <div class="chart-wrapper">
                <canvas id="inventoryChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>Выполнение плана по цехам</h3>
            <div class="chart-wrapper">
                <canvas id="planChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Кнопка "Настроить пороги" -->
    <div class="d-flex justify-content-center mt-3">
        <a href="{% url 'alerts' %}" class="btn btn-primary">
            Настроить пороги
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Данные для графиков
    const chartData = {{ chart_data|safe }};
    
    // Отладочная информация
    console.log('Данные для графиков:', chartData);
    
    // Ждем полной загрузки DOM и скриптов
    window.addEventListener('load', function() {
        // Инициализация Chart.js графиков
        initCharts();
        
        // Обновляем графики при смене темы
        if (typeof updateChartColors === 'function') {
            updateChartColors();
        }
    });
    
    function initCharts() {
        // Получаем цвета для графиков, проверяя наличие функции
        let colors = {
            textColor: '#1F1F1F',
            gridColor: 'rgba(0, 0, 0, 0.1)',
            backgroundColor: '#FFFFFF'
        };
        
        if (typeof getChartColors === 'function') {
            colors = getChartColors();
        }
        
        // График простоев по цехам (столбчатая диаграмма)
        const downtimeCtx = document.getElementById('downtimeChart');
        if (downtimeCtx) {
            // Очищаем предыдущий график, если он существует и является действительным объектом Chart
            if (window.downtimeChart && typeof window.downtimeChart.destroy === 'function') {
                window.downtimeChart.destroy();
            }
            
            let labels = [];
            let data = [];
            
            if (chartData && chartData.downtime_by_shop) {
                labels = Object.keys(chartData.downtime_by_shop);
                data = Object.values(chartData.downtime_by_shop);
            }
            
            // Если нет данных, показываем "Нет данных"
            if (labels.length === 0) {
                labels = ['Нет данных'];
                data = [0];
            }
            
            window.downtimeChart = new Chart(downtimeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Простои (часы)",
                        data: data,
                        backgroundColor: [
                            "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF"
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // График выпуска продукции (линейный график)
        const productionCtx = document.getElementById('productionChart');
        if (productionCtx) {
            // Очищаем предыдущий график, если он существует и является действительным объектом Chart
            if (window.productionChart && typeof window.productionChart.destroy === 'function') {
                window.productionChart.destroy();
            }
            
            let labels = [];
            let data = [];
            
            if (chartData && chartData.production_by_date) {
                labels = Object.keys(chartData.production_by_date);
                data = Object.values(chartData.production_by_date);
            }
            
            // Если нет данных, показываем "Нет данных"
            if (labels.length === 0) {
                labels = ['Нет данных'];
                data = [0];
            }
            
            window.productionChart = new Chart(productionCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Выпуск, ед.",
                        data: data,
                        borderColor: "#4BC0C0",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // График остатков на складе
        const inventoryCtx = document.getElementById('inventoryChart');
        if (inventoryCtx) {
            // Очищаем предыдущий график, если он существует и является действительным объектом Chart
            if (window.inventoryChart && typeof window.inventoryChart.destroy === 'function') {
                window.inventoryChart.destroy();
            }
            
            let labels = [];
            let data = [];
            
            if (chartData && chartData.inventory_by_date) {
                labels = Object.keys(chartData.inventory_by_date);
                data = Object.values(chartData.inventory_by_date);
            }
            
            // Если нет данных, показываем "Нет данных"
            if (labels.length === 0) {
                labels = ['Нет данных'];
                data = [0];
            }
            
            window.inventoryChart = new Chart(inventoryCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Остатки на складе, ед.",
                        data: data,
                        borderColor: "#9966FF",
                        backgroundColor: "rgba(153, 102, 255, 0.2)",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // График выполнения плана
        const planCtx = document.getElementById('planChart');
        if (planCtx) {
            // Очищаем предыдущий график, если он существует и является действительным объектом Chart
            if (window.planChart && typeof window.planChart.destroy === 'function') {
                window.planChart.destroy();
            }
            
            let labels = [];
            let data = [];
            
            if (chartData && chartData.plan_by_shop) {
                labels = Object.keys(chartData.plan_by_shop);
                data = Object.values(chartData.plan_by_shop);
            }
            
            // Если нет данных, показываем "Нет данных"
            if (labels.length === 0) {
                labels = ['Нет данных'];
                data = [0];
            }
            
            window.planChart = new Chart(planCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Выполнение плана, %",
                        data: data,
                        backgroundColor: [
                            "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF"
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: colors.gridColor
                            },
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
    }
    
    // Функция для обновления данных графиков
    function updateChartsWithData(newChartData) {
        console.log('Обновление графиков с новыми данными:', newChartData);
        
        // Получаем цвета для графиков, проверяя наличие функции
        let colors = {
            textColor: '#1F1F1F',
            gridColor: 'rgba(0, 0, 0, 0.1)',
            backgroundColor: '#FFFFFF'
        };
        
        if (typeof getChartColors === 'function') {
            colors = getChartColors();
        }
        
        // Обновляем данные для графика простоев
        if (window.downtimeChart) {
            const downtimeData = newChartData.downtime_by_shop || {};
            const labels = Object.keys(downtimeData);
            const data = Object.values(downtimeData);
            
            window.downtimeChart.data.labels = labels.length > 0 ? labels : ['Нет данных'];
            window.downtimeChart.data.datasets[0].data = data.length > 0 ? data : [0];
            window.downtimeChart.update();
        }
        
        // Обновляем данные для графика производства
        if (window.productionChart) {
            const productionData = newChartData.production_by_date || {};
            const labels = Object.keys(productionData);
            const data = Object.values(productionData);
            
            window.productionChart.data.labels = labels.length > 0 ? labels : ['Нет данных'];
            window.productionChart.data.datasets[0].data = data.length > 0 ? data : [0];
            window.productionChart.update();
        }
        
        // Обновляем данные для графика остатков
        if (window.inventoryChart) {
            const inventoryData = newChartData.inventory_by_date || {};
            const labels = Object.keys(inventoryData);
            const data = Object.values(inventoryData);
            
            window.inventoryChart.data.labels = labels.length > 0 ? labels : ['Нет данных'];
            window.inventoryChart.data.datasets[0].data = data.length > 0 ? data : [0];
            window.inventoryChart.update();
        }
        
        // Обновляем данные для графика выполнения плана
        if (window.planChart) {
            const planData = newChartData.plan_by_shop || {};
            const labels = Object.keys(planData);
            const data = Object.values(planData);
            
            window.planChart.data.labels = labels.length > 0 ? labels : ['Нет данных'];
            window.planChart.data.datasets[0].data = data.length > 0 ? data : [0];
            window.planChart.update();
        }
    }
</script>
{% endblock %}